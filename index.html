<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<select id="selectButton"></select>
<style>
div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 60px;					
    height: 30px;					
    padding: 2px;				
    font: 14px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}
</style>
<body>
<script>

// set the dimensions and margins of the graph
const margin = {top: 10, right: 30, bottom: 30, left: 60},
    width = 800 - margin.left - margin.right,
    height = 550 - margin.top - margin.bottom;

// append the svg object to the body of the page
const svg = d3.select("body")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

var color = d3.scaleOrdinal(d3.schemeCategory10);

//Read the data
d3.csv("https://kaf4.github.io/data/US_Race_AllAge.csv")
.then(function(data){
  data.forEach(function(d){
    d.year = d3.timeParse("%Y")(d.Year);
    races = data.columns.slice([1]);
    });

races.push("All")

d3.select("#selectButton").selectAll('myOptions')
    .data(races).enter().append('option')
    .text(function (d) { return d; })
    .attr("value", function (d) { return d; })

const x = d3.scaleTime()
      .domain(d3.extent(data, function(d) { return d.year; }))
      .range([ 0, width ]);

const y = d3.scaleLinear()
      .domain([25, 75])
      .range([ height, 0]);
      
    svg.append("g")
      .attr("transform", `translate(0, ${height})`)
      .call(d3.axisBottom(x));    
    svg.append("g")
      .call(d3.axisLeft(y));
      
var div = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);
var dateFormat = d3.timeFormat("%Y");
var selection = "Total"

var slices = data.columns.slice(1).map(function(race) {
        return {race: race, values: data.map(function(d){
        return {year: d3.timeParse("%Y")(d.Year),
                measurement: +d[selection]};})};});
                
var valueLine = d3.line().defined(d => !isNaN(d.measurement))
    .x(function(d) { return x(d.year); })
    .y(function(d) { return y(+d.measurement); });
    

var selectRaceGroups = svg.selectAll(".raceGroups")
		    .data(slices, function(d){return d ? d.key : this.key;})
		    .enter()
		    .append("g")
		    .attr("class", "raceGroups")
    
const lines = selectRaceGroups.selectAll(".line")
      .data(slices)
      .enter()
      .append("path")
        .attr("fill", "none")
        .attr("stroke", function(d){return color(d.key) })
        .attr("stroke-width", 1)
        .attr("d", function(d){return valueLine(d.values)})

selectRaceGroups.selectAll("dot")	
	.data(data)			
    .enter().append("circle")				
    .attr("r", 2.5)		
	.attr("cx", function(d) { return x(d.year);})
    .attr("cy", function(d) { return y(d[selection]); })
     .on("mouseover", function(d) {div.transition().duration(200)		
            .style("opacity", .9);		
      div.html(dateFormat(d.year) + "<br/>"  + d[selection] +"%")	
            .style("left", (d3.event.pageX) + "px")		
            .style("top", (d3.event.pageY) + "px");})					
     .on("mouseout", function(d) { div.transition().duration(500)		
             .style("opacity", 0);});
    
var linelabel = selectRaceGroups.append("text")
      .datum(function(d) { return {race: d.race, value: d.values[0]}; })
      .attr("transform", function(d) { return "translate(" + x(d.value.year) + "," + y(d.value.measurement) + ")"; })
      .attr("x", 3)
      .attr("dy", ".35em")
      .text(function(d) { return selection;});  
      
lines.attr("d", function(d){return valueLine(d.values)}).attr("class", "line")

function update(selection) {

d3.selectAll("circle").remove()
linelabel.remove()


if (selection == "All") {

var slice2 = data.columns.slice(1).map(function(race) {
        return {race: race, values: data.map(function(d){
        return {year: d3.timeParse("%Y")(d.Year),
                measurement: +d[race]};})};});
                
var selectRaceGroups = svg.selectAll(".raceGroups").data(slice2);
var color = d3.scaleOrdinal(d3.schemeCategory10);

selectRaceGroups.selectAll("path.line").data(slice2)
    .attr("fill", "none")
    .attr("stroke", "green")
    .attr("stroke-width", 1)
    .attr("d", function(d){return valueLine(d.values)})
    
selectRaceGroups.selectAll("dot")	
	.data(function(d) {return d.values})			
    .enter().append("circle")				
    .attr("r", 2.5)		
	.attr("cx", function(d) { return x(d.year);})
    .attr("cy", function(d) { return y(d.measurement); })
     .on("mouseover", function(d) {div.transition().duration(200)		
            .style("opacity", .9);		
      div.html(dateFormat(d.year) + "<br/>"  + d.measurement +"%")	
            .style("left", (d3.event.pageX) + "px")		
            .style("top", (d3.event.pageY) + "px");})					
     .on("mouseout", function(d) { div.transition().duration(500)		
             .style("opacity", 0);});

linelabel = selectRaceGroups.append("text")
      .datum(function(d) { return {race: d.race, value: d.values[0]}; })
      .attr("transform", function(d) { return "translate(" + x(d.value.year) + "," + y(d.value.measurement) + ")"; })
      .attr("x", 3)
      .attr("dy", ".35em")
      .text(function(d) { return d.race;});

}

else{

var slice = data.columns.slice(1).map(function(race) {
        return {race: race, values: data.map(function(d){
        return {year: d3.timeParse("%Y")(d.Year),
                measurement: +d[selection]};})};});
var selectRaceGroups = svg.selectAll(".raceGroups").data(slice);

var color = d3.scaleOrdinal(d3.schemeCategory10);

selectRaceGroups.selectAll("path.line").data(slice)
    .attr("fill", "none")
    .attr("stroke", "red")
    .attr("stroke-width", 1)
    .attr("d", function(d){return valueLine(d.values)})
    
selectRaceGroups.selectAll("dot")	
	.data(function(d) {return d.values})			
    .enter().append("circle")				
    .attr("r", 2.5)		
	.attr("cx", function(d) { return x(d.year);})
    .attr("cy", function(d) { return y(d.measurement); })
     .on("mouseover", function(d) {div.transition().duration(200)		
            .style("opacity", .9);		
      div.html(dateFormat(d.year) + "<br/>"  + d.measurement +"%")	
            .style("left", (d3.event.pageX) + "px")		
            .style("top", (d3.event.pageY) + "px");})					
     .on("mouseout", function(d) { div.transition().duration(500)		
             .style("opacity", 0);});

linelabel = selectRaceGroups.append("text")
      .datum(function(d) { return {race: d.race, value: d.values[0]}; })
      .attr("transform", function(d) { return "translate(" + x(d.value.year) + "," + y(d.value.measurement) + ")"; })
      .attr("x", 3)
      .attr("dy", ".35em")
      .text(function(d) { return selection;});

}
}

d3.select("#selectButton").on("change", function(event,d) {
const selectedState = d3.select(this).property("value")
update(selectedState)
    })

})
</script></body></html>